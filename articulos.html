<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proyecto HTML + Bootstrap + JS</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- SweetAlert2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">tRebeca - Tabla Dinamica</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#inicio">Inicio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#sobre">Sobre</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#contacto">Contacto</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section id="inicio" class="hero-section bg-light py-5">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-12">
                    <h3>
                        Mi tabla dinamica
                    </h3>
                    <table id="trebeca" class="table table-striped trebeca" >
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Edad</th>
                                <th>Ciudad</th>
                                <th>
                                    <button type="button" class="btn btn-success btn-sm me-1 btn-add-row">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Ana</td>
                                <td>28</td>
                                <td>Madrid</td>
                                <td>
                                    <button type="button" class="btn btn-warning btn-sm me-1 edit-btn">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn btn-danger btn-sm delete-btn">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td>Juan</td>
                                <td>34</td>
                                <td>Barcelona</td>
                                <td>
                                    <button type="button" class="btn btn-warning btn-sm me-1 edit-btn">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn btn-danger btn-sm delete-btn">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td>Laura</td>
                                <td>25</td>
                                <td>Valencia</td>
                                <td>
                                    <button type="button" class="btn btn-warning btn-sm me-1 edit-btn">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn btn-danger btn-sm delete-btn">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-end fw-bold">Total de registros:</td>
                                <td class="fw-bold" id="totalCount">3</td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <!-- Modal para añadir/editar registro -->
                    <div class="modal fade" id="personModal" tabindex="-1" aria-labelledby="personModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="personModalLabel">Añadir Persona</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="personForm">
                                        <div class="mb-3">
                                            <label for="personName" class="form-label">Nombre</label>
                                            <input type="text" class="form-control" id="personName" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="personAge" class="form-label">Edad</label>
                                            <input type="number" class="form-control" id="personAge" min="1" max="120" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="personCity" class="form-label">Ciudad</label>
                                            <input type="text" class="form-control" id="personCity" required>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <button type="button" class="btn btn-primary" id="savePersonBtn">Guardar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <p>&copy; 2025 tRebeca - Tabla Dinamica. Todos los derechos reservados.</p>
                </div>
                <div class="col-md-6 text-end">
                    <p>Desarrollado con ❤️ usando Bootstrap</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom JavaScript -->
    <script src="js/trebeca.js"></script>
    <script>
        // trebeca.js
        const data = [
            {id: 1, code: "7500810031872", nombre: 'Pan Blanco Bimbo Grande', precio: 45.0, cantidad: 5, unidad:"pieza", total:["cantidad", "precio"], categoria: 'Panaderia', foto: 'img/bread.png'},
            {id: 2, code: "7500810020920", nombre: 'Leche Entera Santa Clara 1L', precio: 32, cantidad: 1, unidad:"litro", total:["cantidad", "precio"], categoria: 'Lacteos', foto: 'img/milk.png'},
            {id: 3, code: "7501055307906", nombre: 'Huevos Bachoco', precio: 32, cantidad: 12, unidad:"pieza", total:["cantidad", "precio"], categoria: 'Huevos', foto: 'img/eggs.png'},
            {id: 4, code: "7501017362950", nombre: 'Queso Manchego 250g', precio: 41, cantidad: 1, unidad:"kg", total:["cantidad", "precio"], categoria: 'Lacteos', foto: 'img/cheese.png'},
            {id: 5, code: "041789001956", nombre: 'Yogur Natural 24oz', precio: 25, cantidad: 24, unidad:"onza", total:["cantidad", "precio"], categoria: 'Lacteos', foto: 'img/yogurt.png'},
            {id: 6, code: "7500810031877", nombre: 'Mantequilla 200g', precio: 2.20, cantidad: 1, unidad:"pieza", total:["cantidad", "precio"], categoria: 'Lacteos', foto: 'img/butter.png'},
            {id: 7, code: "7500810031878", nombre: 'Jamón Cocido 200g', precio: 2.85, cantidad: 1, unidad:"pieza", total:["cantidad", "precio"], categoria: 'Embutidos', foto: 'img/ham.png'},
            {id: 8, code: "7500810031879", nombre: 'Pan Integral Bimbo 500g', precio: 1.30, cantidad: 1, unidad:"pieza", total:["cantidad", "precio"], categoria: 'Panaderia', foto: 'img/bread.png'},
            {id: 9, code: "7500810031880", nombre: 'Leche Condensada 397g', precio: 1.10, cantidad: 1, unidad:"pieza", total:["cantidad", "precio"], categoria: 'Lacteos', foto: 'img/heavycream.png'},
            {id: 10, code: "7500810031881", nombre: 'Papas', precio: 0.80, cantidad: 1, unidad:"pieza", total:["cantidad", "precio"], categoria: 'Verduras', foto: 'img/potatoes.png'},
            {id: 11, code: "7500810031882", nombre: 'Manzanas', precio: 1.50, cantidad: 1, unidad:"pieza", total:["cantidad", "precio"], categoria: 'Frutas', foto: 'img/apple.png'},
            {id: 12, code: "7500810031883", nombre: 'Pollo Entero', precio: 5.00, cantidad: 1, unidad:"pieza", total:["cantidad", "precio"], categoria: 'Carnes', foto: 'img/chicken.png'},
            {id: 13, code: "7500810031884", nombre: 'Arroz 1kg', precio: 1.20, cantidad: 1, unidad:"pieza", total:["cantidad", "precio"], categoria: 'Cereales', foto: 'img/rice.png'},
            {id: 14, code: "7500810031885", nombre: 'Pasta 500g', precio: 0.90, cantidad: 1, unidad:"pieza", total:["cantidad", "precio"], categoria: 'Cereales', foto: 'img/pasta.png'},
            {id: 15, code: "7500810031886", nombre: 'Aceite de Oliva 1L', precio: 4.50, cantidad: 1, unidad:"pieza", total:["cantidad", "precio"], categoria: 'Aceites', foto: 'img/sunfloweroil.png'},
            {id: 16, code: "7500810031887", nombre: 'Azúcar 1kg', precio: 1.10, cantidad: 1, unidad:"pieza", total:["cantidad", "precio"], categoria: 'Dulces', foto: 'img/sugar.png'},
            {id: 17, code: "7500810031888", nombre: 'Sal 1kg', precio: 0.50, cantidad: 1, unidad:"pieza", total:["cantidad", "precio"], categoria: 'Condimentos', foto: 'img/salt.png'},
        ];

        const config_default = {
            search: {
                value: '',
                fields: ['code','nombre', 'categoria']
            },
            table: {
                cols: [
                    {label: 'Code', field: 'code', type: 'text', function: (event) => { search_code(event); }, typefunc: 'keyup'},
                    {label: 'Producto', field: 'nombre', type : 'text', valuedefault: 'Nuevo Producto'},
                    {label: 'Precio', field: 'precio', type: 'money'},
                    {label: 'Unidad', field: 'unidad', type: 'text'},
                    {label: 'Cantidad', field: 'cantidad', type: 'number', edit: false},
                    {label: 'Total', field: 'total', type: 'money', operator: 'multiply', add: false, edit: false, reference: ["cantidad", "precio"]},
                    {label: 'Categoría', field: 'categoria', type: 'select', options:["Abarrotes","Panaderia", "Lacteos", "Huevos", "Embutidos", "Verduras", "Frutas", "Carnes", "Cereales", "Aceites", "Dulces", "Condimentos"], valuedefault: 'Abarrotes'},
                    {label: 'Foto', field: 'foto', type: 'image', valuedefault: 'img/ghost.png', function: (event) => { upfile(event); }, typefunc: 'change'},
                    {label: '*', field: 'actions', type: 'button', buttons: ["add", "edit", "delete", "save", "btn_extra"]}
                ],
                footer: {
                    label: 'Total de registros:',
                    field: 'count',
                    type: 'text'
                }
            },
            buttons: [
                { name: "add", label: '<i class="fas fa-plus"></i>', class: 'btn btn-success btn-sm me-1', modo: "new"  },
                { name: "edit", label: '<i class="fas fa-edit"></i>', class: 'btn btn-warning btn-sm me-1', modo: "row" },
                { name: "delete", label: '<i class="fas fa-trash"></i>', class: 'btn btn-danger btn-sm me-1', modo: "row" },
                { name: "save", label: '<i class="fas fa-save"></i>', class: 'btn btn-success btn-sm me-1', modo: "row" },
                { name: "btn_extra", label: '<i class="fas fa-info-circle"></i>', class: 'btn btn-info btn-sm m-1', modo: "row_extra", function: (event) => { other_function(event); } },
            ],
            tableClass: 'trebeca',
            // Usando referencias a funciones (más seguro que eval)
            add: (event) => {btn_add(event)},
            edit: (event) => {btn_edit(event)},
            delete: (event) => {btn_delete(event)},   
            save: (event) => {btn_save(event)},
        };

        const btn_add = () => {
            console.log("Agregar nuevo registro");
        }
        
        const btn_edit = (event) => {
            //console.log(event);
            const id = event.target.id;
            console.log("Editar registro id:", id);
            
        }

        const btn_delete = (event) => {
            const id = event.target.id;
            console.log("Eliminar registro id:", id);
        }

        const btn_save = (event) => {
            console.log(event);
            /*const id = event.children[0].id;
            console.log("Guardar registro id:", id);*/
        }

        const other_function = (event) => {
            const td_bts = event.target.closest('td');
            let row = data.find(item => item.id == td_bts.dataset.id);
            Swal.fire({
                title: 'Otra función',
                text: 'Esta es otra función de ejemplo.',
                icon: 'info',
                confirmButtonText: 'Cerrar'
            });
        }

        const upfile = (event) => {
            const input = event.target || null;
            const tr = event.target.closest('tr') || null;
            const a = event.target.closest('td')
            //console.log(a, tr);
            
            const img = tr.querySelector('img') || null;
            const file = input.files[0] || null;
            if(file){
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img_src = e.target.result || '';
                    console.log(img_src);
                    img.src = img_src;
                };
                reader.readAsDataURL(file);
            }
        }

        const search_code = (event) => {
            const t = event.key || '';
            switch(t){
                case 'Enter':
                    const input = event.target || null;
                    const tr = event.target.closest('tr') || null;
                    const inputs = tr.querySelectorAll('input') || [];
                    const row = data.find( item => item.code === input.value );

                    if(row){
                        for(element of inputs){
                            const field = element.dataset.field || '';
                            console.log(field, element);
                            
                            if(field !== '' && typeof row[field] !== "undefined" && typeof element.value !== "undefined"){
                                try{
                                    element.value = row[field];
                                }catch(e){
                                    console.log(e);
                                }
                            }
                        }
                    }else{
                        for(element of inputs){
                            const field = element.dataset.field || '';
                            if(field !== "code"){
                                element.value = "";
                            }
                        }
                    }
                    
                    break;
            }
        }

        document.addEventListener('DOMContentLoaded', trebeca(config_default, data));

        
    </script>
</body>
</html>
